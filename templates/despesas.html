{% extends "base.html" %}
{% load humanize %}

{% block title %}Despesas ‚Äî FinCtrl{% endblock %}

{% block content %}
<style>
  /* √≠cones que rotacionam */
  .rotate-icon {
    transition: transform .25s ease;
  }
  .rotate-icon.rotated {
    transform: rotate(90deg);
  }

  /* üîπ Chip azul do per√≠odo */
  .period-chip {
    display: flex;
    align-items: center;
    gap: .25rem;
    padding: 4px 10px;
    border-radius: 999px;
    background: #eaf1ff;                   /* azul clarinho */
    border: 1px solid #bcd2ff;             /* tom da borda */
  }

  /* remove bordas internas */
  .period-chip select,
  .period-chip input[type="number"] {
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
    padding: 0 3px;
    height: 24px;
    font-size: 0.85rem;
  }

  .period-chip select:focus,
  .period-chip input[type="number"]:focus {
    outline: none;
  }

  /* bot√µes das setas */
  .period-chip .nav-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background: #0d6efd;        /* azul principal Bootstrap */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: background .2s ease;
  }

  .period-chip .nav-btn:hover {
    background: #0b5ed7;        /* azul mais escuro */
  }

  .period-chip .nav-btn i {
    font-size: .8rem;
  }
</style>


<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0 d-flex align-items-center gap-2">
    <i class="bi bi-wallet2 text-danger"></i> Despesas
    <span class="badge text-bg-light">M√™s: {{ month|stringformat:"02d" }}/{{ year }}</span>
  </h3>

  <div class="d-flex align-items-center gap-2 flex-wrap">

    <form method="post" action="{% url 'import_fixed' 'EX' %}" class="d-flex align-items-center gap-2">
      {% csrf_token %}
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <button class="btn btn-outline-primary btn-sm">
        <i class="bi bi-cloud-download me-1"></i> Importar fixas
      </button>
    </form>

    <!-- Dropdown: criar se√ß√£o -->
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle btn-sm" data-bs-toggle="dropdown">
        + Add Se√ß√£o
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3" style="min-width:280px">
        <form method="get" action="{% url 'add_section' %}" class="d-flex gap-2">
          <input type="hidden" name="kind" value="EX">
          <input class="form-control" name="name" placeholder="Nome da se√ß√£o (ex: Despesas Fixas)">
          <button class="btn btn-primary" type="submit">Criar</button>
        </form>
      </div>
    </div>

    <div class="dropdown">
      <button class="btn btn-outline-primary btn-sm dropdown-toggle d-flex align-items-center gap-1" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-list"></i> A√ß√µes
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item btn btn-outline-primary btn-sm" data-bulk="expand"><i class="bi bi-arrows-expand me-1"></i> Expandir todas</button></li>
        <li><button class="dropdown-item btn btn-outline-primary btn-sm" data-bulk="collapse"><i class="bi bi-arrows-collapse me-1"></i> Recolher todas</button></li>
      </ul>
    </div>

    <form action="" method="get" class="d-flex align-items-center gap-2">
      <div class="period-chip">
        <!-- m√™s anterior -->
        <button type="submit" name="nav" value="prev" class="nav-btn" title="M√™s anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <!-- M√äS -->
        <select name="month">
          {% for m in months %}
            <option value="{{ m }}" {% if m == month %}selected{% endif %}>
              {{ m|stringformat:"02d" }}
            </option>
          {% endfor %}
        </select>
        <!-- ANO bem coladinho -->
        <input type="number" name="year" value="{{ year }}" style="width:50px">
        <!-- pr√≥ximo m√™s -->
        <button type="submit" name="nav" value="next" class="nav-btn" title="Pr√≥ximo m√™s">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <button class="btn btn-outline-primary btn-sm">
        <i class="bi bi-funnel me-1"></i> Filtrar
      </button>
    </form>

  </div>
</div>

{% for sec in sections %}
  <div class="card shadow-soft mb-3">
    <div class="card-header bg-white border-0 py-2">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <button
            type="button"
            class="btn btn-link text-decoration-none d-flex align-items-center gap-2 p-0 collapse-toggle"
            data-collapse-target="#cat-{{ sec.category.id }}"
            aria-controls="cat-{{ sec.category.id }}"
            aria-expanded="false">
            <i class="bi bi-chevron-right rotate-icon"></i>
            <i class="bi bi-folder2-open text-danger"></i>
            <span class="fw-semibold">{{ sec.category.name }}</span>
            <span class="badge text-bg-secondary">{{ sec.txs|length }} itens</span>
          </button>

          <a href="{% url 'new_transaction' %}?category={{ sec.category.id }}&desc={{ sec.category.name|urlencode }}&next={{ request.get_full_path|urlencode }}#cat-{{ sec.category.id }}"
            class="btn btn-success btn-sm rounded-circle p-0 d-flex align-items-center justify-content-center"
            style="width:26px;height:26px;"
            data-bs-toggle="tooltip" data-bs-title="Nova transa√ß√£o" aria-label="Nova transa√ß√£o">
            <i class="bi bi-plus-lg"></i>
          </a>
        </div>

        <button class="btn btn-sm btn-danger disabled border-0 rounded-pill px-3">
          <small class="fw-semibold">Total: R$ {{ sec.total|floatformat:2|intcomma }}</small>
        </button>
      </div>
    </div>


    <!-- FECHADO por padr√£o -->
    <div id="cat-{{ sec.category.id }}" class="collapse">
      <div class="card-body pt-0">
        {% if sec.txs %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descri√ß√£o</th>
                  <th>Conta</th>
                  <th>Status</th>
                  <th class="text-end">Valor</th>
                  <th class="text-end">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
              {% for t in sec.txs %}
                <tr>
                  <td>{{ t.date|date:"d/m/Y" }}</td>
                  <td>
                    {{ t.description }}
                    {% if t.is_fixed %}
                        <span class="badge text-bg-info ms-1">Fixa</span>
                    {% endif %}
                  </td>
                  <td><span class="badge badge-account">{{ t.account.name }}</span></td>
                  <td>
                    {% if t.status == "PAG" %}
                      <span class="badge text-bg-success">Paga</span>
                    {% else %}
                      <span class="badge text-bg-warning text-dark">Pendente</span>
                    {% endif %}
                    {% if t.installment_no %}
                      <span class="badge text-bg-light ms-1">{{ t.installment_no }}/{{ t.installment_count }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end text-danger">R$ {{ t.amount|floatformat:2|intcomma }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{% url 'edit_transaction' t.id %}?next={{ request.get_full_path|urlencode }}#cat-{{ sec.category.id }}">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form method="post" action="{% url 'delete_transaction' t.id %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}#cat-{{ sec.category.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                              onclick="return confirm('Excluir este lan√ßamento?')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                    <form method="post" action="{% url 'toggle_status' t.id %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}#cat-{{ sec.category.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-success" title="Alternar Paga/Pendente">
                        <i class="bi bi-check2-circle"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <span class="text-muted">Sem lan√ßamentos nesta se√ß√£o.</span>
        {% endif %}
      </div>
    </div>
  </div>
{% empty %}
  <div class="alert alert-info">Nenhuma se√ß√£o de despesas. Use ‚Äú+ Add Se√ß√£o‚Äù.</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Helper: sincroniza aria/√≠cone de TODOS os bot√µes que apontam para um collapse
  function syncButtonsFor(el, isOpen){
    const sel = '#' + el.id;
    document.querySelectorAll(`.collapse-toggle[data-collapse-target="${sel}"]`).forEach(btn=>{
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      const icon = btn.querySelector('.rotate-icon');
      if (icon) icon.classList.toggle('rotated', isOpen);
    });
  }

  // Toggle manual robusto (sem depender de data-bs-toggle)
  function toggleCollapse(sel){
    const el = document.querySelector(sel);
    if(!el) return;
    if (window.bootstrap && bootstrap.Collapse){
      const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
      if (el.classList.contains('show')) inst.hide(); else inst.show();
    } else {
      el.classList.toggle('show');
      syncButtonsFor(el, el.classList.contains('show'));
    }
  }

  // Liga bot√µes individuais
  document.querySelectorAll('.collapse-toggle').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const sel = btn.getAttribute('data-collapse-target');
      toggleCollapse(sel);
    });
  });

  // Eventos Bootstrap para manter √≠cone/aria sincronizados mesmo com transi√ß√µes
  document.querySelectorAll('.collapse').forEach(el=>{
    el.addEventListener('shown.bs.collapse', ()=> syncButtonsFor(el, true));
    el.addEventListener('hidden.bs.collapse', ()=> syncButtonsFor(el, false));
    // Sincroniza estado inicial (se j√° vier com .show)
    syncButtonsFor(el, el.classList.contains('show'));
  });

  // Expandir/Recolher em massa (se existir menu)
  function setAll(open){
    document.querySelectorAll('.collapse[id^="cat-"]').forEach(el=>{
      if (window.bootstrap && bootstrap.Collapse){
        const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
        open ? inst.show() : inst.hide();
      } else {
        el.classList.toggle('show', open);
        syncButtonsFor(el, open);
      }
    });
  }
  document.body.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-bulk]');
    if (!btn) return;
    const action = btn.getAttribute('data-bulk');
    if (action === 'expand') setAll(true);
    if (action === 'collapse') setAll(false);
    const menu = btn.closest('.dropdown-menu');
    if (menu && window.bootstrap){
      const toggle = menu.previousElementSibling;
      if (toggle) bootstrap.Dropdown.getOrCreateInstance(toggle).hide();
    }
  });

  // Reabre via hash (#algum-id) e sincroniza √≠cone
  if (window.location.hash){
    const el = document.querySelector(window.location.hash);
    if (el && el.classList.contains('collapse')){
      if (window.bootstrap && bootstrap.Collapse){
        bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).show();
      } else {
        el.classList.add('show');
        syncButtonsFor(el, true);
      }
      el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
});
</script>
{% endblock %}
