{% extends "base.html" %}
{% load humanize %}
{% load l10n %}

{% block title %}Nova transação — FinControl{% endblock %}

{% block content %}
<form method="post" action="">
  {% csrf_token %}

  <div class="row g-4">
    <!-- ESQUERDA -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-soft">
        <div class="card-body">
          <h5 class="card-title mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-plus-circle"></i> Nova transação
          </h5>

          <div class="row g-3">
            <!-- Data / Descrição -->
            <div class="col-md-4">
              <label class="form-label">Data</label>
              <input type="date" name="date" class="form-control" value="{{ preset.date }}">
            </div>
            <div class="col-md-8">
              <label class="form-label">Descrição</label>
              <input type="text" name="description" class="form-control"
                     placeholder="ex: Mercado, Salário, Uber" value="{{ preset.description }}">
            </div>

            <!-- Conta / Categoria -->
            <div class="col-md-6">
              <label class="form-label">Conta</label>
              <select name="account" class="form-select">
                {% for a in accounts %}
                  <option value="{{ a.id }}" {% if preset.account_id == a.id|stringformat:"s" %}selected{% endif %}>{{ a.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Categoria</label>
              <select name="category" class="form-select">
                {% for c in categories %}
                  <option value="{{ c.id }}" {% if preset.category_id == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }} — {% if c.kind == "IN" %}Receita{% else %}Despesa{% endif %}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Se for <b>Despesa</b>, valor positivo vira negativo automaticamente.</div>
            </div>

            <!-- Valor -->
            <div class="col-md-6">
              <label class="form-label">Valor</label>
              <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="number" step="0.01" inputmode="decimal" name="amount" class="form-control"
                       placeholder="use negativo para despesa" value="{{ preset.amount }}">
              </div>
            </div>

            <!-- Parcelamento + 1º vencimento -->
            <div class="col-md-3">
              <label class="form-label">Parcelar em</label>
              <select name="installments" id="installments" class="form-select">
                {% for n in installment_options %}
                  <option value="{{ n }}">{{ n }}x</option>
                {% endfor %}
              </select>
              <div class="form-text">Use 1x para lançamento único.</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Primeiro vencimento</label>
              <input type="date" name="first_due" class="form-control" value="{{ preset.date }}">
              <div class="form-text">Se vazio, usa a data acima.</div>
            </div>

            <!-- Status -->
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                {% for code,label in status_choices %}
                  <option value="{{ code }}" {% if code == 'PEN' %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Preview parcelas -->
            <div class="col-md-8 d-flex align-items-end">
              <div class="text-muted" id="parcel-preview">—</div>
            </div>

            <!-- NOVO: Checkbox de Despesa/Receita fixa -->
            <div class="col-md-4 d-flex align-items-center">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="id_is_fixed" name="is_fixed"
                       {% if preset.is_fixed %}checked{% endif %}>
                <label class="form-check-label" for="id_is_fixed">
                  Despesa/Receita fixa
                </label>
                <div class="form-text">
                  Para lançamentos recorrentes <b>sem parcelamento</b>.
                </div>
              </div>
            </div>

            <!-- Ações -->
            <div class="col-12 d-flex justify-content-between pt-2">
              <a href="{{ preset.next|default:'/' }}" class="btn btn-outline-secondary">← Voltar</a>
              <button class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DIREITA (Ações rápidas) -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-soft">
        <div class="card-body">
          <h6 class="text-muted mb-3">Ações rápidas</h6>

          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2">
              {% for v in quick_amounts %}
                <button type="button" class="btn btn-outline-primary btn-sm quick-amount" data-val="{{ v }}">
                  R$ {{ v }}
                </button>
              {% endfor %}
              <button type="button" class="btn btn-outline-danger btn-sm quick-amount" data-val="-50">-50</button>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2">
              {% for rc in recent_categories %}
                <a class="btn btn-outline-secondary btn-sm"
                   href="?category={{ rc.id }}&desc={{ rc.name|urlencode }}&next={{ request.get_full_path|urlencode }}">
                  {% if rc.kind == "IN" %}
                    <i class="bi bi-arrow-down-circle text-success"></i>
                  {% else %}
                    <i class="bi bi-arrow-up-circle text-danger"></i>
                  {% endif %}
                  {{ rc.name }}
                </a>
              {% endfor %}
            </div>
          </div>

          <div class="d-grid gap-2">
            <a class="btn btn-outline-success"
               href="?category=&desc=Receita%20Fixa&fixed=1&next={{ request.get_full_path|urlencode }}">+ Receita Fixa (exemplo)</a>
            <a class="btn btn-outline-dark" href="/admin/core/category/add/">+ Nova Categoria (admin)</a>
          </div>

          <hr>
          <small class="text-muted">
            Dica: use <b>Tab</b> para pular entre campos. Segure <b>Shift</b> no valor para inserir centavos (ex: “100,55”).
          </small>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
(function () {
  // preview de parcelas
  const amount = document.querySelector('input[name="amount"]');
  const inst   = document.getElementById('installments');
  const prev   = document.getElementById('parcel-preview');
  const fixed  = document.getElementById('id_is_fixed');
  const brl = (v) => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);

  function updatePreview() {
    const n  = parseInt(inst?.value || '1', 10);
    const v  = parseFloat((amount?.value || '0').replace(',', '.')) || 0;
    if (!isFinite(v) || n <= 1) { prev.textContent = '—'; return; }
    const unit = Math.abs(v / n);
    prev.innerHTML = `<span class="text-muted">Ficará</span> <b>${n}x</b> de <b>${brl(unit)}</b>`;
  }

  function syncFixed() {
    const n = parseInt(inst?.value || '1', 10);
    const disable = n > 1;
    if (!fixed) return;
    fixed.disabled = disable;
    if (disable) fixed.checked = false;
  }

  amount?.addEventListener('input', updatePreview);
  inst?.addEventListener('change', () => { updatePreview(); syncFixed(); });
  updatePreview();
  syncFixed();

  // botões de valor rápido
  document.querySelectorAll('.quick-amount').forEach(btn => {
    btn.addEventListener('click', () => {
      const amountInput = document.querySelector('input[name="amount"]');
      if (!amountInput) return;
      const val = parseFloat(btn.dataset.val);
      amountInput.value = (val || 0).toString().replace('.', ',');
      amountInput.dispatchEvent(new Event('input'));
    });
  });
})();
</script>
{% endblock %}
