{% extends "base.html" %}
{% load humanize %}
{% load l10n %}

{% block title %}Nova transação — FinCtrl{% endblock %}

{% block content %}
<style>
  /* —— Visual base —————————————————————————— */
  .sheet {
    border: 0;
    border-radius: 16px;
    box-shadow: 0 14px 36px rgba(17,24,39,.06), 0 6px 14px rgba(17,24,39,.05);
    background: linear-gradient(180deg,#ffffff 0%, #fafbff 100%);
  }
  .panel {
    border: 1px solid #eef0f4;
    border-radius: 14px;
    background: #fff;
  }
  .section-title { font-size:.9rem; color:#6b7280; margin-bottom:.35rem }
  .hint { font-size:.8rem; color:#6b7280 }
  .chip { background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:.35rem .65rem }
  .form-control, .form-select { border-radius: 12px; }
  .input-icon{position:absolute; left:.75rem; top:.7rem; color:#9aa3af}
  .with-icon{padding-left:2rem}
  .muted-line{height:1px; background:linear-gradient(90deg,transparent, #e9edf3, transparent)}
  .soft-badge{background:#f6f8fc; border:1px solid #e7ebf2; border-radius:999px; padding:.22rem .5rem; font-size:.75rem}

  /* —— Barra de ações fixa ————————————————— */
  .sticky-actions{
    position: sticky; bottom: 12px; z-index: 30;
    display: flex; justify-content: flex-end; gap:.5rem;
  }
  @media (max-width: 991.98px){ .sticky-actions{ bottom: 0 } }

  /* —— Switch “Fixa” ———————————————— */
  .form-switch .form-check-input{
    width: 2.4em; height:1.2em;
  }
</style>

<form method="post" action="" novalidate>
  {% csrf_token %}

  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h3 class="mb-0 d-flex align-items-center gap-2">
      <i class="bi bi-plus-circle text-primary"></i>
      Nova transação
    </h3>
  </div>

  <div class="row g-4">
    <!-- Form principal -->
    <div class="col-12 col-lg-8">
      <div class="sheet p-3 p-lg-4">
        <div class="row g-4">

          <!-- Linha 1 -->
          <div class="col-md-4">
            <div class="section-title">Data</div>
            <div class="position-relative">
              <i class="bi bi-calendar-event input-icon"></i>
              <input type="date" name="date" class="form-control with-icon" value="{{ preset.date }}">
            </div>
          </div>

          <div class="col-md-8">
            <div class="section-title">Descrição</div>
            <div class="position-relative">
              <i class="bi bi-card-text input-icon"></i>
              <input type="text" name="description" class="form-control with-icon"
                     placeholder="ex: Mercado, Salário, Uber" value="{{ preset.description }}">
            </div>
          </div>

          <!-- Linha 2 -->
          <div class="col-md-6">
            <div class="section-title">Conta</div>
            <div class="position-relative">
              <i class="bi bi-wallet2 input-icon"></i>
              <select name="account" class="form-select with-icon">
                {% for a in accounts %}
                  <option value="{{ a.id }}" {% if preset.account_id == a.id|stringformat:"s" %}selected{% endif %}>{{ a.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="col-md-6">
            <div class="section-title">Categoria</div>
            <div class="position-relative">
              <i class="bi bi-folder2 input-icon"></i>
              <select name="category" class="form-select with-icon">
                {% for c in categories %}
                  <option value="{{ c.id }}" {% if preset.category_id == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }} — {% if c.kind == "IN" %}Receita{% else %}Despesa{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="hint mt-1">Se for <b>Despesa</b>, valor positivo vira negativo automaticamente.</div>
          </div>

          <div class="col-12"><div class="muted-line my-1"></div></div>

          <!-- Linha 3 -->
          <div class="col-md-6">
            <div class="section-title">Valor</div>
            <div class="input-group">
              <span class="input-group-text">R$</span>
              <input type="number" step="0.01" inputmode="decimal" name="amount" class="form-control"
                     placeholder="use negativo para despesa" value="{{ preset.amount }}">
            </div>
          </div>

          <div class="col-md-3">
            <div class="section-title">Parcelar em</div>
            <select name="installments" id="installments" class="form-select">
              {% for n in installment_options %}
                <option value="{{ n }}">{{ n }}x</option>
              {% endfor %}
            </select>
            <div class="hint">Use 1x para lançamento único.</div>
          </div>

          <div class="col-md-3">
            <div class="section-title">Primeiro vencimento</div>
            <div class="position-relative">
              <i class="bi bi-calendar-week input-icon"></i>
              <input type="date" name="first_due" class="form-control with-icon" value="{{ preset.date }}">
            </div>
            <div class="hint">Se vazio, usa a data acima.</div>
          </div>

          <!-- Linha 4 -->
          <div class="col-md-4">
            <div class="section-title">Status</div>
            <select name="status" class="form-select">
              {% for code,label in status_choices %}
                <option value="{{ code }}" {% if code == 'PEN' %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-8 d-flex align-items-end">
            <div class="text-muted">
              <span class="me-2">Resumo:</span>
              <span id="parcel-preview" class="soft-badge">—</span>
            </div>
          </div>

          <!-- Linha 5 -->
          <div class="col-md-6">
            <label class="form-switch form-check">
              <input class="form-check-input" type="checkbox" id="id_is_fixed" name="is_fixed" {% if preset.is_fixed %}checked{% endif %}>
              <span class="form-check-label ms-2">Despesa/Receita fixa</span>
            </label>
            <div class="hint">Para lançamentos recorrentes <b>sem parcelamento</b>.</div>
          </div>

          <!-- Barra de ações (mobile + sticky) -->
          <div class="col-12 sticky-actions mt-2 d-lg-none">
            <a href="{{ preset.next|default:'/' }}" class="btn btn-light border"><i class="bi bi-arrow-left"></i> Voltar</a>
            <button class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Painel lateral -->
    <div class="col-12 col-lg-4">
      <div class="panel p-3 p-lg-4">
        <h6 class="text-muted mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-lightning-charge"></i> Ações rápidas
        </h6>

        <div class="mb-3">
          <div class="d-flex flex-wrap gap-2">
            {% for v in quick_amounts %}
              <button type="button" class="btn btn-outline-primary btn-sm quick-amount" data-val="{{ v }}">R$ {{ v }}</button>
            {% endfor %}
            <button type="button" class="btn btn-outline-danger btn-sm quick-amount" data-val="-50">-50</button>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex flex-wrap gap-2">
            {% for rc in recent_categories %}
              <a class="btn btn-outline-secondary btn-sm"
                 href="?category={{ rc.id }}&desc={{ rc.name|urlencode }}&next={{ request.get_full_path|urlencode }}">
                {% if rc.kind == "IN" %}
                  <i class="bi bi-arrow-down-circle text-success"></i>
                {% else %}
                  <i class="bi bi-arrow-up-circle text-danger"></i>
                {% endif %}
                {{ rc.name }}
              </a>
            {% endfor %}
          </div>
        </div>

        <div class="d-grid gap-2">
          <a class="btn btn-outline-success"
             href="?category=&desc=Receita%20Fixa&fixed=1&next={{ request.get_full_path|urlencode }}">+ Receita Fixa (exemplo)</a>
          <a class="btn btn-outline-dark" href="/admin/core/category/add/">+ Nova Categoria (admin)</a>
        </div>

        <hr class="my-3">
        <small class="text-muted">
          Dica: use <b>Tab</b> para pular entre campos. Segure <b>Shift</b> no valor para inserir centavos (ex: “100,55”).
        </small>
      </div>
    </div>
  </div>

  <!-- Barra de ações fixa (desktop) -->
  <div class="sticky-actions d-none d-lg-flex mt-3">
    <a href="{{ preset.next|default:'/' }}" class="btn btn-light border"><i class="bi bi-arrow-left"></i> Voltar</a>
    <button class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const amount = document.querySelector('input[name="amount"]');
  const inst   = document.getElementById('installments');
  const prev   = document.getElementById('parcel-preview');
  const fixed  = document.getElementById('id_is_fixed');
  const brl = (v) => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);

  function updatePreview() {
    const n  = parseInt(inst?.value || '1', 10);
    const v  = parseFloat((amount?.value || '0').toString().replace(',', '.')) || 0;
    if (!isFinite(v) || n <= 1) { prev.textContent = '—'; return; }
    const unit = Math.abs(v / n);
    prev.textContent = `${n}x de ${brl(unit)}`;
  }
  function syncFixed() {
    const n = parseInt(inst?.value || '1', 10);
    const disable = n > 1;
    if (!fixed) return;
    fixed.disabled = disable;
    if (disable) fixed.checked = false;
  }
  amount?.addEventListener('input', updatePreview);
  inst?.addEventListener('change', () => { updatePreview(); syncFixed(); });
  updatePreview(); syncFixed();

  // valores rápidos
  document.querySelectorAll('.quick-amount').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.querySelector('input[name="amount"]');
      if (!input) return;
      const val = parseFloat(btn.dataset.val);
      input.value = (val || 0).toString().replace('.', ',');
      input.dispatchEvent(new Event('input'));
    });
  });

  // Ctrl/Cmd + Enter para salvar
  document.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
      document.querySelector('form button.btn-primary')?.click();
    }
  });
})();
</script>
{% endblock %}
