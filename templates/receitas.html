{% extends "base.html" %}
{% load humanize %}

{% block title %}Receitas — FinCtrl{% endblock %}

{% block content %}
<style>
  .rotate-icon { transition: transform 0.25s ease; }
  .rotate-icon.rotated { transform: rotate(90deg); }
</style>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0 d-flex align-items-center gap-2">
    <i class="bi bi-graph-up text-success"></i> Receitas
  </h3>

  <div class="d-flex align-items-center gap-2 flex-wrap">

    <!-- Ações -->
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center gap-1" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-list"></i> Ações
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item" data-bulk="expand"><i class="bi bi-arrows-expand me-1"></i> Expandir todas</button></li>
        <li><button class="dropdown-item" data-bulk="collapse"><i class="bi bi-arrows-collapse me-1"></i> Recolher todas</button></li>
      </ul>
    </div>

    <!-- Add seção -->
    <a class="btn btn-primary btn-sm d-flex align-items-center gap-1" href="{% url 'add_section' %}?kind=IN">
      <i class="bi bi-plus-circle"></i> Add Seção
    </a>

    <!-- Filtro -->
    <form action="" method="get" class="d-flex align-items-center gap-2">
      <select name="month" class="form-select form-select-sm">
        {% for m in months %}
          <option value="{{ m }}" {% if m == month %}selected{% endif %}>Mês {{ m|stringformat:"02d" }}</option>
        {% endfor %}
      </select>
      <input type="number" name="year" class="form-control form-control-sm" style="width: 90px" value="{{ year }}">
      <button class="btn btn-outline-primary btn-sm">Ir</button>
      <span class="badge text-bg-light">Mês: {{ month|stringformat:"02d" }}/{{ year }}</span>
    </form>
    <form method="post" action="{% url 'import_fixed' 'IN' %}" class="d-flex align-items-center gap-2">
      {% csrf_token %}
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <button class="btn btn-outline-primary btn-sm">
        <i class="bi bi-cloud-download me-1"></i> Importar fixas  
      </button>
    </form>
  </div>
</div>

{% for sec in sections %}
  <div class="card shadow-soft mb-3">
    <div class="card-header bg-white border-0 py-2">
      <div class="d-flex justify-content-between align-items-center">
        <button
          type="button"
          class="btn btn-link text-decoration-none d-flex align-items-center gap-2 p-0 collapse-toggle"
          data-collapse-target="#cat-{{ sec.category.id }}"
          aria-controls="cat-{{ sec.category.id }}"
          aria-expanded="false">
          <i class="bi bi-chevron-right rotate-icon"></i>
          <i class="bi bi-folder2-open text-success"></i>
          <span class="fw-semibold">{{ sec.category.name }}</span>
          <span class="badge text-bg-secondary">{{ sec.txs|length }} itens</span>
        </button>

        <button class="btn btn-sm btn-success disabled border-0 rounded-pill px-3">
          <small class="fw-semibold">Total: R$ {{ sec.total|floatformat:2|intcomma }}</small>
        </button>
      </div>
    </div>

    <!-- FECHADO por padrão -->
    <div id="cat-{{ sec.category.id }}" class="collapse">
      <div class="card-body pt-0">
        {% if sec.txs %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descrição</th>
                  <th>Conta</th>
                  <th>Status</th>
                  <th class="text-end">Valor</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody>
              {% for t in sec.txs %}
                <tr>
                  <td>{{ t.date|date:"d/m/Y" }}</td>
                  <td>
                    {{ t.description }}
                    {% if t.is_fixed %}
                        <span class="badge text-bg-info ms-1">Fixa</span>
                    {% endif %}
                  </td>
                  <td><span class="badge badge-account">{{ t.account.name }}</span></td>
                  <td>
                    {% if t.status == "PAG" %}
                      <span class="badge text-bg-success">Paga</span>
                    {% else %}
                      <span class="badge text-bg-warning text-dark">Pendente</span>
                    {% endif %}
                    {% if t.installment_no %}
                      <span class="badge text-bg-light ms-1">{{ t.installment_no }}/{{ t.installment_count }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end text-success">R$ {{ t.amount|floatformat:2|intcomma }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{% url 'edit_transaction' t.id %}?next={{ request.get_full_path|urlencode }}#cat-{{ sec.category.id }}">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form method="post" action="{% url 'delete_transaction' t.id %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}#cat-{{ sec.category.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                              onclick="return confirm('Excluir este lançamento?')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                    <form method="post" action="{% url 'toggle_status' t.id %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}#cat-{{ sec.category.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-success" title="Alternar Paga/Pendente">
                        <i class="bi bi-check2-circle"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <span class="text-muted">Sem lançamentos nesta seção.</span>
        {% endif %}
      </div>
    </div>
  </div>
{% empty %}
  <div class="alert alert-info">Nenhuma seção de receitas. Use “+ Add Seção”.</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Helper: sincroniza aria/ícone de TODOS os botões que apontam para um collapse
  function syncButtonsFor(el, isOpen){
    const sel = '#' + el.id;
    document.querySelectorAll(`.collapse-toggle[data-collapse-target="${sel}"]`).forEach(btn=>{
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      const icon = btn.querySelector('.rotate-icon');
      if (icon) icon.classList.toggle('rotated', isOpen);
    });
  }

  // Toggle manual robusto (sem depender de data-bs-toggle)
  function toggleCollapse(sel){
    const el = document.querySelector(sel);
    if(!el) return;
    if (window.bootstrap && bootstrap.Collapse){
      const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
      if (el.classList.contains('show')) inst.hide(); else inst.show();
    } else {
      el.classList.toggle('show');
      syncButtonsFor(el, el.classList.contains('show'));
    }
  }

  // Liga botões individuais
  document.querySelectorAll('.collapse-toggle').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const sel = btn.getAttribute('data-collapse-target');
      toggleCollapse(sel);
    });
  });

  // Eventos Bootstrap para manter ícone/aria sincronizados mesmo com transições
  document.querySelectorAll('.collapse').forEach(el=>{
    el.addEventListener('shown.bs.collapse', ()=> syncButtonsFor(el, true));
    el.addEventListener('hidden.bs.collapse', ()=> syncButtonsFor(el, false));
    // Sincroniza estado inicial (se já vier com .show)
    syncButtonsFor(el, el.classList.contains('show'));
  });

  // Expandir/Recolher em massa (se existir menu)
  function setAll(open){
    document.querySelectorAll('.collapse[id^="cat-"]').forEach(el=>{
      if (window.bootstrap && bootstrap.Collapse){
        const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
        open ? inst.show() : inst.hide();
      } else {
        el.classList.toggle('show', open);
        syncButtonsFor(el, open);
      }
    });
  }
  document.body.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-bulk]');
    if (!btn) return;
    const action = btn.getAttribute('data-bulk');
    if (action === 'expand') setAll(true);
    if (action === 'collapse') setAll(false);
    const menu = btn.closest('.dropdown-menu');
    if (menu && window.bootstrap){
      const toggle = menu.previousElementSibling;
      if (toggle) bootstrap.Dropdown.getOrCreateInstance(toggle).hide();
    }
  });

  // Reabre via hash (#algum-id) e sincroniza ícone
  if (window.location.hash){
    const el = document.querySelector(window.location.hash);
    if (el && el.classList.contains('collapse')){
      if (window.bootstrap && bootstrap.Collapse){
        bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).show();
      } else {
        el.classList.add('show');
        syncButtonsFor(el, true);
      }
      el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
});
</script>
{% endblock %}
