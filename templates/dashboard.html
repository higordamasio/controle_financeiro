{% extends "base.html" %}
{% load humanize %}

{% block title %}Dashboard — FinCtrl{% endblock %}

{% block content %}
<style>
  /* rotação do ícone */
  .rotate-icon{display:inline-block;transition:transform .2s ease}
  .rotate-icon.rotated{transform:rotate(90deg)}

  /* pílula de seta (idêntica à das listas) */
  .chev-pill{
    width: 36px; height: 36px; padding: 0;
    display: inline-flex; align-items: center; justify-content: center;
    border: 0; border-radius: 10px;
    background: #fff;
    box-shadow: inset 0 0 0 1px #e5e7eb;   /* borda suave */
    cursor: pointer;
  }
  .chev-pill:hover{ box-shadow: inset 0 0 0 1px #cbd5e1; background:#f8fafc }

  /* versão com acento "amarelinho" como no screenshot */
  .chev-pill.chev-accent{
    background: #fff7ed;                         /* laranja muito claro */
    box-shadow: inset 0 0 0 1px #fbbf24;         /* amarelo */
  }
  .chev-pill.chev-accent .rotate-icon{ color:#f59e0b } /* ícone âmbar */
</style>


<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0 d-flex align-items-center gap-2">
    <i class="bi bi-speedometer2 text-primary"></i> Dashboard
  </h3>

  <div class="d-flex align-items-center gap-2 flex-wrap">
    <form action="" method="get" class="d-flex align-items-center gap-2">
      <select name="month" class="form-select form-select-sm">
        {% for m in months %}
          <option value="{{ m }}" {% if m == month %}selected{% endif %}>Mês {{ m|stringformat:"02d" }}</option>
        {% endfor %}
      </select>
      <input type="number" name="year" class="form-control form-control-sm" style="width: 90px" value="{{ year }}">
      <button class="btn btn-outline-primary btn-sm">Filtrar</button>
      <span class="badge text-bg-light">Mês: {{ month|stringformat:"02d" }}/{{ year }}</span>
    </form>
  </div>
</div>

<!-- Cards de totais -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-arrow-down-circle text-success fs-4"></i>
          <div>
            <div class="text-muted small">Receitas</div>
            <div class="fs-5 fw-semibold text-success">R$ {{ total_in|floatformat:2|intcomma }}</div>
          </div>
        </div>
        <span class="badge text-bg-success">Pagas: R$ {{ total_in_paid|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-arrow-up-circle text-danger fs-4"></i>
          <div>
            <div class="text-muted small">Despesas</div>
            <div class="fs-5 fw-semibold text-danger">R$ {{ total_ex_abs|floatformat:2|intcomma }}</div>
          </div>
        </div>
        <span class="badge text-bg-danger">Pagas: R$ {{ total_ex_paid_abs|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-cash-coin text-primary fs-4"></i>
          <div>
            <div class="text-muted small">Saldo (mês)</div>
            <div class="fs-5 fw-semibold {% if net >= 0 %}text-success{% else %}text-danger{% endif %}">
              R$ {{ net|floatformat:2|intcomma }}
            </div>
          </div>
        </div>
        <span class="badge text-bg-secondary">Pagas: R$ {{ net_paid|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Saldos por conta -->
<div class="card shadow-soft border-0 mb-3">
  <div class="card-header bg-white border-0 py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-bank text-primary"></i>
        <span class="fw-semibold">Saldos por conta</span>
      </div>
    </div>
  </div>
  <div class="card-body pt-0">
    <div class="d-flex flex-wrap gap-2">
      {% for ab in account_balances %}
        <span class="badge bg-white border text-dark px-3 py-2 rounded-pill">
          <i class="bi bi-wallet2 me-1 text-muted"></i>
          {{ ab.account.name }}:
          <strong class="{% if ab.balance >= 0 %}text-success{% else %}text-danger{% endif %} ms-1">
            R$ {{ ab.balance|floatformat:2|intcomma }}
          </strong>
        </span>
      {% empty %}
        <span class="text-muted">Sem contas.</span>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Despesas por categoria -->
<div class="card shadow-soft border-0 mb-3">
  <div class="card-header bg-white border-0 py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2 collapse-toggle"
            data-collapse-target="#dash-categorias"
            aria-controls="dash-categorias"
            aria-expanded="true"
            role="button"
            style="cursor:pointer;">
        <i class="bi bi-chevron-right rotate-icon rotated"></i>
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-bar-chart-line-fill text-danger"></i>
            <span class="fw-semibold">Despesas por categoria</span>
        </div>
      </div>
    </div>
  </div>

  <!-- aberto por padrão -->
  <div id="dash-categorias" class="collapse show">
    <div class="card-body pt-0">
      {% if ex_by_cat %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:60%">Categoria</th>
                <th class="text-end" style="width:40%">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in ex_by_cat %}
                {% if forloop.counter <= 10 %}
                  <tr>
                    <td class="d-flex align-items-center gap-2">
                      <i class="bi bi-folder2 text-danger opacity-75"></i>
                      <span>{{ item.name }}</span>
                    </td>
                    <td class="text-end text-danger">
                      R$ {{ item.total|floatformat:2|intcomma }}
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <span class="text-muted">Sem dados para o mês.</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- Lançamentos recentes -->
<div class="card shadow-soft border-0">
  <div class="card-header bg-white border-0 py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2 collapse-toggle"
            data-collapse-target="#dash-recentes"
            aria-controls="dash-recentes"
            aria-expanded="true"
            role="button"
            style="cursor:pointer;">
        <i class="bi bi-chevron-right rotate-icon rotated"></i>
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-clock-history text-muted"></i>
                <span class="fw-semibold">Lançamentos recentes</span>
            </div>
      </div>
    </div>
  </div>

  <!-- aberto por padrão -->
  <div id="dash-recentes" class="collapse show">
    <div class="card-body pt-0">
      {% if recent %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Conta</th>
              <th>Categoria</th>
              <th>Status</th>
              <th class="text-end">Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for t in recent %}
            <tr>
              <td>{{ t.date|date:"d/m/Y" }}</td>
              <td>{{ t.description }}</td>
              <td><span class="badge badge-account">{{ t.account.name }}</span></td>
              <td>
                {% if t.category.kind == "IN" %}
                  <span class="badge text-bg-success">Receita</span>
                {% else %}
                  <span class="badge text-bg-danger">Despesa</span>
                {% endif %}
              </td>
              <td>
                {% if t.status == "PAG" %}
                  <span class="badge text-bg-success">Paga</span>
                {% else %}
                  <span class="badge text-bg-warning text-dark">Pendente</span>
                {% endif %}
              </td>
              <td class="text-end {% if t.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                R$ {{ t.amount|floatformat:2|intcomma }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <span class="text-muted">Sem lançamentos recentes.</span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Helper: sincroniza aria/ícone de TODOS os botões que apontam para um collapse
  function syncButtonsFor(el, isOpen){
    const sel = '#' + el.id;
    document.querySelectorAll(`.collapse-toggle[data-collapse-target="${sel}"]`).forEach(btn=>{
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      const icon = btn.querySelector('.rotate-icon');
      if (icon) icon.classList.toggle('rotated', isOpen);
    });
  }

  // Toggle manual robusto (sem depender de data-bs-toggle)
  function toggleCollapse(sel){
    const el = document.querySelector(sel);
    if(!el) return;
    if (window.bootstrap && bootstrap.Collapse){
      const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
      if (el.classList.contains('show')) inst.hide(); else inst.show();
    } else {
      el.classList.toggle('show');
      syncButtonsFor(el, el.classList.contains('show'));
    }
  }

  // Liga botões individuais
  document.querySelectorAll('.collapse-toggle').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const sel = btn.getAttribute('data-collapse-target');
      const el  = document.querySelector(sel);
      if (!el) return;

      // estado atual antes de togglar
      const willOpen = !el.classList.contains('show');

      // gira o ícone imediatamente (feedback instantâneo)
      const icon = btn.querySelector('.rotate-icon');
      if (icon) icon.classList.toggle('rotated', willOpen);
      btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

      // segue com o toggle “oficial”
      toggleCollapse(sel);
    });
  });


  // Eventos Bootstrap para manter ícone/aria sincronizados mesmo com transições
  document.querySelectorAll('.collapse').forEach(el=>{
    el.addEventListener('shown.bs.collapse', ()=> syncButtonsFor(el, true));
    el.addEventListener('hidden.bs.collapse', ()=> syncButtonsFor(el, false));
    // Sincroniza estado inicial (se já vier com .show)
    syncButtonsFor(el, el.classList.contains('show'));
  });

  // Expandir/Recolher em massa (se existir menu)
  function setAll(open){
    document.querySelectorAll('.collapse[id^="cat-"]').forEach(el=>{
      if (window.bootstrap && bootstrap.Collapse){
        const inst = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
        open ? inst.show() : inst.hide();
      } else {
        el.classList.toggle('show', open);
        syncButtonsFor(el, open);
      }
    });
  }
  document.body.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-bulk]');
    if (!btn) return;
    const action = btn.getAttribute('data-bulk');
    if (action === 'expand') setAll(true);
    if (action === 'collapse') setAll(false);
    const menu = btn.closest('.dropdown-menu');
    if (menu && window.bootstrap){
      const toggle = menu.previousElementSibling;
      if (toggle) bootstrap.Dropdown.getOrCreateInstance(toggle).hide();
    }
  });

  // Reabre via hash (#algum-id) e sincroniza ícone
  if (window.location.hash){
    const el = document.querySelector(window.location.hash);
    if (el && el.classList.contains('collapse')){
      if (window.bootstrap && bootstrap.Collapse){
        bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).show();
      } else {
        el.classList.add('show');
        syncButtonsFor(el, true);
      }
      el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
});
</script>
{% endblock %}

