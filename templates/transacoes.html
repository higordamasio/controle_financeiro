{% extends "base.html" %}
{% load humanize %}

{% block title %}Transações — FinCtrl{% endblock %}

{% block content %}
<style>
  .rotate-icon { display:inline-block; transition:transform .25s ease; vertical-align:middle; }
  .rotate-icon.rotated { transform: rotate(90deg); }
  .table thead th { white-space:nowrap; }
  .badge-account { background:#f8f9fa; border:1px solid #e5e7eb; color:#111827; }
  .chip { border:1px solid #e5e7eb; background:#fff; padding:.35rem .6rem; border-radius:50rem; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0 d-flex align-items-center gap-2">
    <i class="bi bi-journal-text text-primary"></i> Registro de transações
  </h3>
</div>

<!-- Filtros -->
<form method="get" class="card shadow-soft border-0 mb-3">
  <div class="card-body row g-2 align-items-end">
    <div class="col-6 col-md-2">
      <label class="form-label small text-muted">Mês</label>
      <select name="month" class="form-select form-select-sm">
        {% for m in months %}
          <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small text-muted">Ano</label>
      <input type="number" name="year" class="form-control form-control-sm" value="{{ year }}">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small text-muted">Conta</label>
      <select name="account" class="form-select form-select-sm">
        <option value="">Todas</option>
        {% for a in accounts %}
          <option value="{{ a.id }}" {% if selected_account == a.id %}selected{% endif %}>{{ a.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small text-muted">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">Todos</option>
        {% for code,label in status_choices %}
          <option value="{{ code }}" {% if selected_status == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small text-muted">Buscar</label>
      <input type="text" name="q" class="form-control form-control-sm" placeholder="descrição ou valor…" value="{{ q }}">
    </div>

    <div class="col-12 d-flex justify-content-end gap-2">
      <a href="{% url 'transactions' %}?month={{ month }}&year={{ year }}" class="btn btn-light border btn-sm">
        Limpar
      </a>
      <button class="btn btn-outline-primary btn-sm">
        <i class="bi bi-funnel me-1"></i> Filtrar
      </button>
    </div>
  </div>
</form>

<!-- Cards de totais -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-arrow-down-circle text-success fs-4"></i>
          <div>
            <div class="text-muted small">Receitas</div>
            <div class="fs-5 fw-semibold text-success">R$ {{ total_in|floatformat:2|intcomma }}</div>
          </div>
        </div>
        <span class="badge text-bg-success">Pagas: R$ {{ total_in_paid|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-arrow-up-circle text-danger fs-4"></i>
          <div>
            <div class="text-muted small">Despesas</div>
            <div class="fs-5 fw-semibold text-danger">R$ {{ total_ex_abs|floatformat:2|intcomma }}</div>
          </div>
        </div>
        <span class="badge text-bg-danger">Pagas: R$ {{ total_ex_paid_abs|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card shadow-soft border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-cash-coin text-primary fs-4"></i>
          <div>
            <div class="text-muted small">Saldo (mês)</div>
            <div class="fs-5 fw-semibold {% if net >= 0 %}text-success{% else %}text-danger{% endif %}">
              R$ {{ net|floatformat:2|intcomma }}
            </div>
          </div>
        </div>
        <span class="badge text-bg-secondary">Pagas: R$ {{ net_paid|floatformat:2|intcomma }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Lista -->
<div class="card shadow-soft border-0">
  <div class="card-header bg-white border-0 py-2 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-list-ul text-primary"></i>
      <span class="fw-semibold">Transações do mês</span>
      <span class="badge text-bg-light">Total: {{ tx_count }}</span>
    </div>
  </div>
  <div class="card-body pt-0">
    {% if txs %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Data</th>
            <th>Descrição</th>
            <th>Conta</th>
            <th>Categoria</th>
            <th>Status</th>
            <th class="text-end">Valor</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for t in txs %}
          <tr>
            <td>{{ t.date|date:"d/m/Y" }}</td>
            <td>
              {{ t.description }}
              {% if t.is_fixed %}
                <span class="badge text-bg-info ms-1">Fixa</span>
              {% endif %}
              {% if t.installment_no %}
                <span class="badge text-bg-light ms-1">{{ t.installment_no }}/{{ t.installment_count }}</span>
              {% endif %}
            </td>
            <td><span class="badge badge-account">{{ t.account.name }}</span></td>
            <td>
              {% if t.category.kind == "IN" %}
                <span class="badge text-bg-success">Receita</span>
              {% else %}
                <span class="badge text-bg-danger">Despesa</span>
              {% endif %}
              <span class="ms-1">{{ t.category.name }}</span>
            </td>
            <td>
              {% if t.status == "PAG" %}
                <span class="badge text-bg-success">Paga</span>
              {% else %}
                <span class="badge text-bg-warning text-dark">Pendente</span>
              {% endif %}
            </td>
            <td class="text-end {% if t.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
              R$ {{ t.amount|floatformat:2|intcomma }}
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{% url 'edit_transaction' t.id %}?next={{ request.get_full_path|urlencode }}">
                <i class="bi bi-pencil"></i>
              </a>
              <form method="post" action="{% url 'toggle_status' t.id %}" style="display:inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn btn-sm btn-outline-success" title="Alternar Paga/Pendente">
                  <i class="bi bi-check2-circle"></i>
                </button>
              </form>
              <form method="post" action="{% url 'delete_transaction' t.id %}" style="display:inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Excluir este lançamento?')">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <span class="text-muted">Nenhuma transação encontrada neste mês com os filtros aplicados.</span>
    {% endif %}
  </div>
</div>
{% endblock %}
