{% extends "base.html" %}
{% load humanize %}

{% block title %}Editar transação — FinCtrl{% endblock %}

{% block content %}
<style>
  .sheet{border:0;border-radius:16px;box-shadow:0 14px 36px rgba(17,24,39,.06),0 6px 14px rgba(17,24,39,.05);background:linear-gradient(180deg,#ffffff 0%, #fafbff 100%)}
  .panel{border:1px solid #eef0f4;border-radius:14px;background:#fff}
  .section-title{font-size:.9rem;color:#6b7280;margin-bottom:.35rem}
  .hint{font-size:.8rem;color:#6b7280}
  .chip{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .65rem}
  .input-icon{position:absolute;left:.75rem;top:.7rem;color:#9aa3af}
  .with-icon{padding-left:2rem}
  .soft-badge{background:#f6f8fc;border:1px solid #e7ebf2;border-radius:999px;padding:.22rem .5rem;font-size:.75rem}
  .sticky-actions{position:sticky;bottom:12px;z-index:30;display:flex;justify-content:flex-end;gap:.5rem}
  @media (max-width:991.98px){.sticky-actions{bottom:0}}
</style>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0 d-flex align-items-center gap-2">
    <i class="bi bi-pencil-square text-primary"></i> Editar transação
    <span class="chip">{{ tx.description }}</span>
  </h3>
  <div class="d-none d-lg-flex gap-2">
    <a href="{{ next }}" class="btn btn-light border"><i class="bi bi-arrow-left"></i> Voltar</a>
    <button form="form-edit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
  </div>
</div>

<div class="row g-4">
  <!-- Form -->
  <div class="col-12 col-lg-8">
    <div class="sheet p-3 p-lg-4">
      <form id="form-edit" method="post" class="row g-4">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ next }}">

        <!-- Linha 1 -->
        <div class="col-md-4">
          <div class="section-title">Data</div>
          <input type="date" name="date" class="form-control" value="{{ tx.date|date:'Y-m-d' }}" required>
        </div>
        <div class="col-md-8">
          <div class="section-title">Descrição</div>
          <input type="text" name="description" class="form-control" value="{{ tx.description }}" required>
        </div>

        <!-- Linha 2 -->
        <div class="col-md-6">
          <div class="section-title">Conta</div>
          <div class="position-relative">
            <i class="bi bi-wallet2 input-icon"></i>
            <select name="account" class="form-select with-icon" required>
              {% for acc in accounts %}
                <option value="{{ acc.id }}" {% if tx.account_id == acc.id %}selected{% endif %}>{{ acc.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="section-title">Categoria</div>
          <div class="position-relative">
            <i class="bi bi-folder2 input-icon"></i>
            <select name="category" class="form-select with-icon" required>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if tx.category_id == cat.id %}selected{% endif %}>
                  {{ cat.name }} — {% if cat.kind == "IN" %}Receita{% else %}Despesa{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Linha 3 -->
        <div class="col-md-6">
          <div class="section-title">Valor</div>
          <div class="input-group">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" name="amount" class="form-control" value="{{ tx.amount }}">
          </div>
        </div>
        <div class="col-md-6">
          <div class="section-title">Status</div>
          <select name="status" class="form-select">
            {% for code,label in status_choices %}
              <option value="{{ code }}" {% if tx.status == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Linha 4 -->
        <div class="col-md-6">
          <div class="form-check mt-2">
            {% if tx.installment_count|default:0 > 1 %}
              <input class="form-check-input" type="checkbox" id="id_is_fixed" name="is_fixed" disabled>
              <label class="form-check-label" for="id_is_fixed">Despesa/Receita fixa</label>
              <div class="hint">Lançamentos de <b>parcelas</b> não podem ser fixos.</div>
            {% else %}
              <input class="form-check-input" type="checkbox" id="id_is_fixed" name="is_fixed"
                     {% if tx.is_fixed %}checked{% endif %}>
              <label class="form-check-label" for="id_is_fixed">Despesa/Receita fixa</label>
              <div class="hint">Use para recorrências sem parcelamento.</div>
            {% endif %}
          </div>
        </div>

        <!-- Ações (mobile) -->
        <div class="col-12 sticky-actions d-lg-none">
          <a href="{{ next }}" class="btn btn-light border"><i class="bi bi-arrow-left"></i> Voltar</a>
          <button class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Painel lateral: detalhes -->
  <div class="col-12 col-lg-4">
    <div class="panel p-3 p-lg-4">
      <h6 class="text-muted mb-3 d-flex align-items-center gap-2">
        <i class="bi bi-info-circle"></i> Detalhes
      </h6>

      <div class="d-flex flex-column gap-2">
        <div class="d-flex justify-content-between">
          <span class="text-muted">Parcelas</span>
          <span class="soft-badge">
            {% if tx.installment_count %}{{ tx.installment_no|default:"–" }}/{{ tx.installment_count }}{% else %}—{% endif %}
          </span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Tipo</span>
          {% if tx.category.kind == "IN" %}
            <span class="badge text-bg-success">Receita</span>
          {% else %}
            <span class="badge text-bg-danger">Despesa</span>
          {% endif %}
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Fixa</span>
          {% if tx.is_fixed %}
            <span class="badge text-bg-info">Sim</span>
          {% else %}
            <span class="badge text-bg-light">Não</span>
          {% endif %}
        </div>
      </div>

      <hr class="my-3">
      <small class="text-muted">
        Dica: alterou a categoria para <b>Despesa</b>? Valores positivos serão convertidos para negativos automaticamente.
      </small>
    </div>
  </div>
</div>

<!-- Barra de ações fixa (desktop) -->
<div class="sticky-actions d-none d-lg-flex mt-3">
  <a href="{{ next }}" class="btn btn-light border"><i class="bi bi-arrow-left"></i> Voltar</a>
  <button form="form-edit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar</button>
</div>
{% endblock %}
